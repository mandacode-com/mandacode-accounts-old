-include .make.env

# ──────────────────────────────
# 📦 Application Build Variables
# ──────────────────────────────
MODULE_NAME        ?= mandacode.com/accounts/token
REGISTRY           ?=
APP_NAME           ?=
TAG                ?=
APP_IMAGE          := $(REGISTRY)/$(APP_NAME)

# ──────────────────────────────
# 📁 Directory Paths
# ──────────────────────────────
DOCKER_CONTEXT     := ./docker

# ──────────────────────────────
# 🎯 Default Target
# ──────────────────────────────
all: build-app

# ──────────────────────────────
# 🚀 Run Application
# ──────────────────────────────
run:
	go run ./cmd/server

# ──────────────────────────────
# 🐳 Build & Push App Image
# ──────────────────────────────
build-app: check-tag
	docker build -t $(APP_IMAGE):$(TAG) -f $(DOCKER_CONTEXT)/app.Dockerfile .

push-app: build-app
	docker push $(APP_IMAGE):$(TAG)

# ──────────────────────────────
# 🧪 Unit Tests
# ──────────────────────────────
test-unit:
	go test ./test/unit/...

# ──────────────────────────────
# 🛑 Validation Helpers
# ──────────────────────────────
check-tag:
ifndef TAG
	$(error TAG is required. Usage: make TAG=v1.2.3)
endif

# ──────────────────────────────
# 🧾 PHONY Targets
# ──────────────────────────────
.PHONY: \
	all run \
	build-app push-app \
	test-unit \
	check-tag
